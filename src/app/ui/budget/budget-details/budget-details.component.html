<ion-header [translucent]="true" class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button (click)="onNavigate()" [defaultHref]="routes.TAB_4_BUDGETS.toString()"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ stats().budget.budgetName }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="presentActionSheet()">
        <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">

  <div class="ion-padding-horizontal balance-hero">
    <div class="balance-label">Available Real Balance</div>
    <div class="balance-amount">
      {{ stats().realBalance | currency }}
    </div>

    @if (pendingTransactions() !== 0) {
      <ion-badge color="medium" style="margin-top: 8px; opacity: 0.8">
        {{ pendingTransactions() | currency }} pending
      </ion-badge>
    }
  </div>

  <ion-card class="ion-margin">
    <ion-card-header>
      <div style="display: flex; justify-content: space-between;">
        <ion-card-subtitle>{{ stats().budget.recurringRule }}</ion-card-subtitle>
        <ion-badge [color]="stats().budget.active ? 'success' : 'medium'">
          {{ stats().budget.active ? 'Active' : 'Archived' }}
        </ion-badge>
      </div>
    </ion-card-header>

    <ion-card-content>
      <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
        <span class="text-dark"><strong>{{ stats().expensesAmount | currency }}</strong> spent</span>
        <span>Limit: {{ stats().budget.budgetCap | currency }}</span>
      </div>
      <ion-progress-bar [value]="usagePercentage()" [color]="healthColor()"></ion-progress-bar>
      <div style="text-align: right; margin-top: 4px; font-size: 0.8em; color: var(--ion-color-medium);">
        {{ usagePercentage() | percent }} utilized
      </div>
    </ion-card-content>
  </ion-card>

  <ion-grid class="ion-padding-horizontal">
    <ion-row>
      <ion-col size="6">
        <div class="stat-card">
          <ion-icon name="trending-down-outline" color="danger"></ion-icon>
          <div class="stat-label">Expenses</div>
          <div class="stat-value text-danger">
            {{ stats().expensesAmount | currency }}
          </div>
        </div>
      </ion-col>
      <ion-col size="6">
        <div class="stat-card">
          <ion-icon name="trending-up-outline" color="success"></ion-icon>
          <div class="stat-label">Earnings</div>
          <div class="stat-value text-success">
            {{ stats().earningsAmount | currency }}
          </div>
        </div>
      </ion-col>
    </ion-row>
  </ion-grid>

  <ion-accordion-group class="ion-margin-top" [multiple]="true">

    <ion-accordion value="debts">
      <ion-item slot="header" color="light">
        <ion-icon slot="start" name="swap-horizontal-outline"></ion-icon>
        <ion-label>Debts & Lending</ion-label>
      </ion-item>
      <div class="ion-padding" slot="content">
        <ion-item lines="none">
          <ion-label>
            <h3>Owed to others</h3>
            <p>Debt Received</p>
          </ion-label>
          <span slot="end" class="ion-text-end text-danger font-bold">
            {{ stats().debtReceivedAmount | currency }}
          </span>
        </ion-item>
        <ion-item lines="none">
          <ion-label>
            <h3>Owed to this budget</h3>
            <p>Debt Lent</p>
          </ion-label>
          <span slot="end" class="ion-text-end text-success font-bold">
            {{ stats().debtLendedAmount | currency }}
          </span>
        </ion-item>
      </div>
    </ion-accordion>

    <ion-accordion value="participants">
      <ion-item slot="header" color="light">
        <ion-icon slot="start" name="people-outline"></ion-icon>
        <ion-label>Participants</ion-label>
        <ion-badge slot="end" color="primary">{{ stats().budget.participants.length }}</ion-badge>
      </ion-item>
      <div class="ion-padding-bottom" slot="content">
        <ion-list lines="none">
          @for (user of stats().budget.participants; track user.id) {
            <ion-item>
              <ion-avatar slot="start">
                <img [src]="'https://ui-avatars.com/api/?name=' + user.username" alt="avatar" />
              </ion-avatar>
              <ion-label>
                <h2>{{ user.username }}</h2>
                <p>Member since {{ user.dateRegistered | date:'shortDate' }}</p>
              </ion-label>
            </ion-item>
          } @empty {
            <div class="ion-padding ion-text-center text-medium">
              No participants assigned.
            </div>
          }
        </ion-list>
      </div>
    </ion-accordion>

  </ion-accordion-group>
</ion-content>
